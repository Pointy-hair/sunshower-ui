version: '2.1'

services:

  proxy:
    image: nginx:1.11.1
    volumes:
      - ./resources/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./resources/nginx/certs/hasli.io.crt:/etc/nginx/hasli.io.crt:ro
      - ./resources/nginx/certs/hasli.io.key:/etc/nginx/hasli.io.key:ro


  ui:
    build: .
    image: "hasli/ui:${UI_VERSION}"


  web-services:
    image: "hasli/web-services"


  db:
    image: "postgres:9.6"


  build-env:
    build:
      context: .
      dockerfile: Dockerfile.build
    image: hasli/ui-build-env
    volumes:
      - ~/.jspm:/root/.jspm
      - ~/.gradle/wrapper:/root/.gradle/wrapper
      - ~/.gradle/gradle.properties:/root/.gradle/gradle.properties


  build-war:
    image: java:8u111-jre
    volumes:
      - ./:/usr/src/
      - ~/.gradle/wrapper:/root/.gradle/wrapper
      - ~/.gradle/gradle.properties:/root/.gradle/gradle.properties
    working_dir: /usr/src/
    command: bash -c "chmod +x gradlew && ./gradlew clean build -Pversion=${ARTIFACT_VERSION}"


  gulp-test:
    extends:
      service: build-env
    volumes:
      - ./:/usr/src/
    working_dir: /usr/src/web-ui
    command: bash -c "chmod +x gradlew && ./gradlew installEnvironment && gulp test"
